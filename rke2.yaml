- name: Check if the sentinel file exists
  ansible.builtin.stat:
    path: "{{ item.sentinel }}"
  register: sentinel_check
  loop: "{{ rancher_files }}"
  tags: always

- name: Download large files if sentinel is missing
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
  when: item.sentinel is not defined or sentinel_check.results | selectattr('stat.exists','equalto',false) | list | length > 0
  loop: "{{ rancher_files }}"
  tags: download

- name: Concatenate split files into a single file
  ansible.builtin.command:
    cmd: "cat {{ rancher_download_path }}/rancher.tar.gz.part* > {{ rancher_download_path }}/rancher.tar.gz"
  args:
    creates: "{{ rancher_download_path }}/rancher.tar.gz"
  tags: concatenate

- name: Decompress the combined file
  ansible.builtin.command:
    cmd: "gzip -d {{ rancher_download_path }}/rancher.tar.gz"
  args:
    creates: "{{ rancher_download_path }}/rancher.tar"
  tags: decompress

- name: Extract the tar archive
  ansible.builtin.unarchive:
    src: "{{ rancher_download_path }}/rancher.tar"
    dest: "{{ rancher_extract_path }}"
    remote_src: yes
  tags: extract

- name: Touch sentinel file if extraction was successful
  ansible.builtin.file:
    path: "{{ item.sentinel }}"
    state: touch
  when: item.sentinel is not defined or sentinel_check.results | selectattr('stat.exists','equalto',false) | list | length > 0
  loop: "{{ rancher_files }}"
  tags: always
