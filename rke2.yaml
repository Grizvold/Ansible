- name: Check if the sentinel file exists
  ansible.builtin.stat:
    path: "{{ item.sentinel }}"
  register: sentinel_check
  loop: "{{ rancher_files }}"
  tags: always

- name: Download large files if sentinel is missing
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
  when: item.sentinel is not defined or sentinel_check.results | selectattr('stat.exists','equalto',false) | list | length > 0
  loop: "{{ rancher_files }}"
  tags: download

- name: Extract files if sentinel is missing
  ansible.builtin.unarchive:
    src: "{{ item.dest }}"
    dest: "{{ rancher_extract_path }}"
    remote_src: yes
  when: item.sentinel is not defined or sentinel_check.results | selectattr('stat.exists','equalto',false) | list | length > 0
  loop: "{{ rancher_files }}"
  tags: extract

- name: Touch sentinel file if extraction was successful
  ansible.builtin.file:
    path: "{{ item.sentinel }}"
    state: touch
  when: item.sentinel is not defined or sentinel_check.results | selectattr('stat.exists','equalto',false) | list | length > 0
  loop: "{{ rancher_files }}"
  tags: always
